<!doctype html>
<html>
  <head>

    <meta charset="utf-8">
    <style>
    body,html{margin:0;width:100%;height:100%;overflow:hidden}
    .width-100{width:100%}
    .height-95{height:95%}
    .height-5{height:5%}
    .padding-5{padding:5 0 5 0}
    .border{border:1px solid #000}
    #map {
        position: relative;
    }
    .emoji {
        position: absolute;
    }
    .emoji img {
        width: 100%;
        height: 100%;
    }
    .bigger {
      font-size: 1.2em;
    }
    </style>

    <script src="https://cdn.jsdelivr.net/emojione/3.0.3/lib/js/emojione.min.js"></script>
  </head>

  <body>
    <div id="map" class="width-100 height-95 border" id="messages" width="100%">
        Connecting to the server...
    </div>
    <input id="input" autofocus class="width-100 height-20 padding-5 bigger" type="text" placeholder="Enter your message">


    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
        (function() {
            localStorage.debug = '*';
            var socket = io();
            socket.on('initialMessage', function (initialData) {
                var speed = {dx: 0, dy: 0};
                var mapElement = document.getElementById('map');
                var inputElement = document.getElementById('input');
                var map = {
                    element: mapElement,
                    emojis: {},
                    addEmoji: function(emojiShortName, centerX, centerY) {
                        var emojiElement = document.createElement('div');
                        emojiElement.innerHTML = emojione.shortnameToImage(emojiShortName);
                        emojiElement.setAttribute('class', 'emoji');
                        emojiElement.setAttribute('title', centerX + ', ' + centerY);
                        emojiElement.setAttribute('data-emoji-shortname', emojiShortName);
                        var emojiSize = this.element.offsetWidth / 30;
                        var factor = this.element.offsetWidth / 40;
                        emojiElement.style.width = emojiSize + 'px';
                        emojiElement.style.height = emojiSize + 'px';
                        emojiElement.style.left = (centerX * factor - emojiSize / 2) + 'px';
                        emojiElement.style.top = (centerY * factor - emojiSize / 2) + 'px';
                        this.element.appendChild(emojiElement);
                        this.emojis[emojiShortName] = emojiElement;
                    },
                    moveEmoji(emojiShortName, dx, dy) {
                        var emojiElement = this.emojis[emojiShortName];
                        emojiElement.style.left = (emojiElement.offsetLeft + dx) + 'px';
                        emojiElement.style.top = (emojiElement.offsetTop + dy) + 'px';
                    },
                    sayEmoji: function(emojiShortName, text) {
                        var emojiElement = this.emojis[emojiShortName];
                        var textElement = document.createElement('div');
                        textElement.innerHTML = text;
                        textElement.setAttribute('class', 'message');
                        emojiElement.appendChild(textElement);
                    },
                    removeEmoji(emojiShortName) {
                        this.emojis[emojiShortName].remove();
                        delete this.emojis[emojiShortName];
                    }
                };

                mapElement.innerHTML = '';

                inputElement.onkeydown = function(e) {
                    e = e || window.event;

                    if (e.keyCode == '38') {
                        speed.dy = -2;
                    }
                    else if (e.keyCode == '40') {
                        speed.dy = +2;
                    }
                    else if (e.keyCode == '37') {
                       speed.dx = -2;
                    }
                    else if (e.keyCode == '39') {
                       speed.dx = +2;
                    }
                }

                inputElement.onkeyup = function(e) {
                    e = e || window.event;

                    if (e.keyCode == '38') {
                        speed.dy = 0;
                    }
                    else if (e.keyCode == '40') {
                        speed.dy = 0;
                    }
                    else if (e.keyCode == '37') {
                       speed.dx = 0;
                    }
                    else if (e.keyCode == '39') {
                       speed.dx = 0;
                    }
                }

                inputElement.addEventListener('change', function(e) {
                    map.sayEmoji(initialData.you.emoji, inputElement.value);
                    socket.emit('messageSent', inputElement.value);
                    inputElement.value = '';
                });

                socket.on('messageReceived', function (data) {
                    map.sayEmoji(data.emoji, data.message);
                });

                socket.on('connected', function (data) {
                    map.addEmoji(
                        data.emoji,
                        data.position.x * mapElement.offsetWidth / 100,
                        data.position.y * mapElement.offsetHeight / 100
                    );
                });

                socket.on('moved', function (data) {
                    map.moveEmoji(data.emoji, data.position.x, data.position.y);
                });

                socket.on('disconnected', function (data) {
                    map.removeEmoji(data.emoji);
                });

                requestAnimationFrame(function loop() {
                    map.moveEmoji(initialData.you.emoji, speed.dx, speed.dy);
                    requestAnimationFrame(loop);
                });

                for (var userId in initialData.users) {
                    var user = initialData.users[userId];
                    map.addEmoji(user.emoji, user.position.x, user.position.y);
                }
            });
        }());
    </script>
  </body>
</html>
